{% extends "dashbase.html" %}

{% block app_content %}

<div class="card">
  <img class="card-img-top" src="{{project.owner.avatar(128)}}" style="width: 128px;" alt="Avatar">
  <div class="card-body">
    <h1 class="card-title">{{project.owner.first_name}} {{project.owner.last_name}}</h1>
    <p class="card-text">({{project.owner.username}})</p>
  </div>
</div>

<div class="card mt-3">
  <h5 class="card-header">Descriptions</h5>
  <div class="card-body">
    <form id="updateprojectform" class="form-horizontal" role="form" method="post" action="">
      {{form.hidden_tag()}}
      <div class="input-group form-group">
        <div class="input-group-prepend">
          {{form.name.label(class_="input-group-text",style="width:150px")}}
        </div>
        {{form.name(class_="form-control",placeholder="Name")}}
        {% if form.name.errors|length > 0 %}
        <div id="signupalert" class="alert alert-danger">
          {% for error in form.name.errors %}
          <span>{{error}}</span>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      <div class="input-group form-group">
        <div class="input-group-prepend">
          {{form.project_type.label(class_="input-group-text",style="width:150px")}}
        </div>
        {% for subfield in form.project_type %}
        <div class="input-group-text">
          {{subfield()}}
        </div>
        {{subfield.label(class_="input-group-text")}}
        {% endfor %}
      </div>
      <div class="input-group form-group">
        <div class="input-group-prepend">
          {{form.version.label(class_="input-group-text",style="width:150px")}}
        </div>
        {{form.version(class_="form-control")}}
      </div>
      <div class="input-group form-group">
        <div class="input-group-prepend">
          <div class="input-group-text" style="width:150px">
            Visibility
          </div>
        </div>
        <div class="input-group-text">
          {{ form.is_public }}
        </div>
        {{form.is_public.label(class_="input-group-text")}}
      </div>
      <div class="input-group form-group">
        <div class="input-group-text" style="width:150px">
          State
        </div>
        <div class="input-group-text">
          {{project.state2str}}
        </div>
      </div>
      <div class="input-group form-group">
        {{form.update(class_="btn btn-info", id="btn-submit")}}
      </div>
    </form>
  </div>
</div>


<div class="card mt-3">
  <h5 class="card-header">Statistics</h5>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered">
        <tr>
          <td>Total Images</td><td>{{project.number_of_images()}}</td>
        </tr>
        <tr>
          <td>Open Images</td><td>{{project.number_of_open_images()}}</td>
        </tr>
        <tr>
          <td>Finished Images</td><td>{{project.number_of_finished_images()}}</td>
        </tr>
        <tr>
          <td>Error Images</td><td>{{project.number_of_error_images()}}</td>
        </tr>
        <tr>
          <td>Project duration (last run)</td>
          <td>{{'%0.1f'|format(project.project_time.total_seconds())}}s</td>
        </tr>
        <tr>
          <td>Numer of total processed images</td>
          <td>{{project.project_images}}</td>
        </tr>
      </table>
    </div>
  </div>
</div>

<div class="card mt-3">
  <h5 class="card-header">BaseFiles</h5>
  <div class="card-body">
    <form id="basefilesform" class="form-horizontal" role="form" method="post" action="{{url_for('projects.remove_project_basefile',projectid=project.id)}}">
      {{ mform.hidden_tag() }}
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead>
            <td></td>
            <td>ID</td>
            <td>Name</td>
            <td>Size</td>
            <td>MD5</td>
            <td>Created</td>
          </thead>
          {% if project.base_files|length==0 %}
          <tr>
            <td colspan="6">No files</td>
          </tr>
          {% else %}
          {% for file in project.base_files %}
          <tr>
            <td>
              <input type="checkbox" name="files" value="{{file.id}}">
            </td>
            <td> {{file.id}} </td>
            <td> <a href="{{url_for('projects.get_project_file',projectid=project.id,fileid=file.id)}}">{{file.name[37:]}}</a> </td>
            <td> {{size2human(file.size)}} </td>
            <td> {{file.md5sum}} </td>
            <td> {{file.timestamp.strftime("%Y-%m-%d %H:%M")}} </td>
          </tr>
          {% endfor %}
          {% endif %}
        </table>
      </div>
      <button onclick="checkall('files')" id="btn-checkall" type="button" class="btn btn-info"><i class="icon-hand-right"></i>Select all</button>
      <button onclick="uncheckall('files')" id="btn-uncheckall" type="button" class="btn btn-info"><i class="icon-hand-right"></i>Unselect all</button>
      {{mform.remove(onclick="return (remove_confirm())", class_="btn btn-danger", id="btn-remove")}}
    </form>

    <div class="input-group form-group mt-3">
      <div class="input-group-prepend">
        <div class="input-group-text">
          New file
        </div>
      </div>
      <div class="custom-file">
        <input type="file" class="custom-file-input" name="file_input"
               id="file_input" oninput="input_filename();"
               accept=".tgz, .zip, .tar.gz">
        <label id="file_input_label" class="custom-file-label" for="image">Choose Basefile...</label>
      </div>
      <button onclick="upload('{{url_for('projects.upload_project_basefile',projectid=project.id)}}');" id="upload_btn" class="btn btn-info">Upload</button>
      <button class="btn btn-primary d-none" id="loading_btn" type="button" disabled>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Uploading...
      </button>
      <button type="button" id="cancel_btn" class="btn btn-secondary d-none">Cancel upload</button>
    </div>
    <div id="progress_wrapper" class="d-none">
      <label id="progress_status"></label>
      <div class="progress mb-3">
      <div id="progress" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
    <div id="alert_wrapper"></div>
  </div>
</div>

<div class="card mt-3">
  <h5 class="card-header">Images</h5>
  <div class="card-body">
    <form id="imageform" class="form-horizontal" role="form" method="post" action="{{url_for('projects.remove_project_image',projectid=project.id)}}">
      {{ iform.hidden_tag() }}
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead>
            <td></td>
            <td>ID</td>
            <td>State</td>
            <td>Error code</td>
            <td>Model</td>
            <td>Created</td>
            <td>Rendered Image</td>
            <td>Log file</td>
            <td>Finished</td>
            <td>Process time</td>
          </thead>
          {% if project.images|length==0 %}
          {#{% if project.images %}#}
          <tr>
            <td colspan="8">No files</td>
          </tr>
          {% else %}
          {% for image in project.images %}
          <tr>
            <td>
              <input type="checkbox" name="images" value="{{image.id}}">
            </td>
            <td><a href="{{url_for('projects.show_image',imageid=image.id)}}">{{image.id}}</a>
            </td>
            <td> {{image.state2str}} </td>
            <td>
              {% if image.state == image.IMAGE_STATE_FINISHED %}
              {{image.error_code}}
              {% else %}
              Unavailable
              {% endif %}
            </td>
            <td>
              <a href="{{url_for('projects.get_project_file',projectid=project.id,fileid=image.model)}}">{{image.model}}</a>
            </td>
            <td> {{image.created.strftime("%Y-%m-%d %H:%M")}} </td>
            <td>
              {% if image.render_image == -1 %}
              Unavailable
              {% else %}
              <a href="{{url_for('projects.get_project_file',projectid=project.id,fileid=image.render_image)}}">{{image.render_image}}</a>
              {% endif %}
            </td>
            <td>
              {% if image.log_file == -1 %}
              Unavailable
              {% else %}
              <a href="{{url_for('projects.get_project_file',projectid=project.id,fileid=image.log_file)}}">{{image.log_file}}</a>
              {% endif %}
            </td>
            <td>
              {% if image.state == image.IMAGE_STATE_FINISHED %}
              {{image.finished.strftime("%Y-%m-%d %H:%M")}}
              {% else %}
              None
              {% endif %}
            </td>
            <td>
              {% if image.state == image.IMAGE_STATE_FINISHED %}
              {{'%0.1f'|format((image.finished-image.requested).total_seconds())}}s
              {% else %}
              None
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% endif %}
        </table>
      </div>
      <div class="input-group form-group">
        <button onclick="checkall('images')" id="btn-checkall" type="button" class="btn btn-info"><i class="icon-hand-right"></i>Select all</button>
        <button onclick="uncheckall('images')" id="btn-uncheckall" type="button" class="btn btn-info"><i class="icon-hand-right"></i>Unselect all</button>
        {{iform.remove(onclick="return (remove_confirm())", class_="btn btn-danger", id="btn-remove")}}
      </div>
    </form>
  </div>
</div>


{% endblock %}

{% block scripts %}
{{super()}}

<script>
  function checkall(name) {
    var x = document.getElementsByName(name);
    var i;
    for (i = 0; i < x.length; i++) {
      if (x[i].type == "checkbox") {
        x[i].checked = true;
      }
    }
  }

  function uncheckall(name) {
    var x = document.getElementsByName(name);
    var i;
    for (i = 0; i < x.length; i++) {
      if (x[i].type == "checkbox") {
        x[i].checked = false;
      }
    }
  }

  function remove_confirm(){
    return (confirm('Do you really want to remove these items?'))
  }


  // Add the following code if you want the name of the file appear on select
  $(".custom-file-input").on("change", function() {
    var fileName = $(this).val().split("\\").pop();
    $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
  });


  // javascript code for upload files
  // Get a reference to the progress bar, wrapper & status label
var progress = document.getElementById("progress");
var progress_wrapper = document.getElementById("progress_wrapper");
var progress_status = document.getElementById("progress_status");

// Get a reference to the 3 buttons
var upload_btn = document.getElementById("upload_btn");
var loading_btn = document.getElementById("loading_btn");
var cancel_btn = document.getElementById("cancel_btn");

// Get a reference to the alert wrapper
var alert_wrapper = document.getElementById("alert_wrapper");

// Get a reference to the file input element & input label
var input = document.getElementById("file_input");
var file_input_label = document.getElementById("file_input_label");

// Function to show alerts
function show_alert(message, alert) {

  alert_wrapper.innerHTML = `
    <div id="alert" class="alert alert-${alert} alert-dismissible fade show" role="alert">
      <span>${message}</span>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  `
}



// Function to upload file
function upload(url) {

  // Reject if the file input is empty & throw alert
  if (!input.value) {

    show_alert("No file selected", "warning")

    return;

  }

  // Create a new FormData instance
  var data = new FormData();

  // Create a XMLHTTPRequest instance
  var request = new XMLHttpRequest();

  // Set the response type
  request.responseType = "json";

  // Clear any existing alerts
  alert_wrapper.innerHTML = "";

  // Disable the input during upload
  input.disabled = true;

  // Hide the upload button
  upload_btn.classList.add("d-none");

  // Show the loading button
  loading_btn.classList.remove("d-none");

  // Show the cancel button
  cancel_btn.classList.remove("d-none");

  // Show the progress bar
  progress_wrapper.classList.remove("d-none");

  progress.setAttribute("style", `width: 0%`);
  progress.setAttribute("aria-valuenow",`0`);

  // Get a reference to the file
  var file = input.files[0];

  // Get a reference to the filename
  var filename = file.name;

  // Get a reference to the filesize & set a cookie
  var filesize = file.size;
  document.cookie = `filesize=${filesize}`;

  // Append the file to the FormData instance
  data.append("file", file);

  // request progress handler
  request.upload.addEventListener("progress", function (e) {

    // Get the loaded amount and total filesize (bytes)
    var loaded = e.loaded;
    var total = e.total

    // Calculate percent uploaded
    var percent_complete = (loaded / total) * 100;

    // Update the progress text and progress bar
    progress.setAttribute("style", `width: ${Math.floor(percent_complete)}%`);
    progress.setAttribute("aria-valuenow", `${Math.floor(percent_complete)}`);
    progress_status.innerText = `${Math.floor(percent_complete)}% uploaded`;

  })

  // request load handler (transfer complete)
  request.addEventListener("load", function (e) {

    if (request.status == 200) {

      show_alert(`${request.response.message}`, "success");


      // timeout without function wrapper is not workin in Chrome!
      setTimeout(function(){
        //banner_change(this);
        location.reload();
      }, 3000);
    }
    else {

      show_alert(`Error uploading file`, "danger");

    }

    reset();

  });

  // request error handler
  request.addEventListener("error", function (e) {

    reset();

    show_alert(`Error uploading file`, "warning");

  });

  // request abort handler
  request.addEventListener("abort", function (e) {

    reset();

    show_alert(`Upload cancelled`, "primary");

  });

  // Open and send the request
  request.open("post", url);
  request.send(data);

  cancel_btn.addEventListener("click", function () {

    request.abort();

  })

}

// Function to update the input placeholder
function input_filename() {

  file_input_label.innerText = input.files[0].name;

}

// Function to reset the page
function reset() {

  // Clear the input
  input.value = null;

  // Hide the cancel button
  cancel_btn.classList.add("d-none");

  // Reset the input element
  input.disabled = false;

  // Show the upload button
  upload_btn.classList.remove("d-none");

  // Hide the loading button
  loading_btn.classList.add("d-none");

  // Hide the progress bar
  progress_wrapper.classList.add("d-none");

  // Reset the progress bar state
  //progress.setAttribute("style", `width: 0%`);
  //progress.setAttribute("aria-valuenow",`0`);

  // Reset the input placeholder
  file_input_label.innerText = "Select file";

}

</script>
{% endblock %}
